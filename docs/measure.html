<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AR 長さ計測</title>
    <link rel="stylesheet" href="style.css" />

    <!-- WebXR Polyfill（対応してない機種の fallback） -->
    <script src="https://cdn.jsdelivr.net/npm/webxr-polyfill@latest/build/webxr-polyfill.min.js"></script>
</head>
<body>
    <button id="backBtn">戻る</button>
    <button id="resetBtn">リセット</button>
    <button id="saveBtn">保存</button>

    <div id="info">画面を2回タップして長さを測定</div>

    <script type="module">
        let xrSession = null;
        let referenceSpace = null;

        let taps = [];
        let hitTestSource = null;

        // ---------------------------
        // ① セッション開始
        // ---------------------------
        async function startAR() {
            if (!navigator.xr) {
                alert("WebXR未対応の端末です");
                return;
            }

            try {
                xrSession = await navigator.xr.requestSession("immersive-ar", {
                    requiredFeatures: ["hit-test", "local-floor"]
                });
            } catch (e) {
                alert("ARセッションを開始できません（HTTPS 必須 / 権限）");
                return;
            }

            const canvas = document.createElement("canvas");
            document.body.appendChild(canvas);
            const ctx = canvas.getContext("webgl", { xrCompatible: true });

            xrSession.updateRenderState({
                baseLayer: new XRWebGLLayer(xrSession, ctx)
            });

            referenceSpace = await xrSession.requestReferenceSpace("local-floor");

            const viewerSpace = await xrSession.requestReferenceSpace("viewer");
            hitTestSource = await xrSession.requestHitTestSource({ space: viewerSpace });

            canvas.addEventListener("click", onTap);

            xrSession.requestAnimationFrame(onXRFrame);
        }

        // ---------------------------
        // ② タップ処理
        // ---------------------------
        function onTap() {
            if (!lastHit) return;

            taps.push(lastHit);

            if (taps.length === 2) {
                const len = calcDistance(taps[0], taps[1]);
                document.getElementById("info").innerText = `長さ：${len.toFixed(2)} cm`;
            }
        }

        // ---------------------------
        // ③ 3D 上の距離計算
        // ---------------------------
        function calcDistance(a, b) {
            const dx = a.x - b.x;
            const dy = a.y - b.y;
            const dz = a.z - b.z;
            return Math.sqrt(dx*dx + dy*dy + dz*dz) * 100; // → cm
        }

        let lastHit = null;

        // ---------------------------
        // ④ フレームループ
        // ---------------------------
        function onXRFrame(t, frame) {
            let session = frame.session;

            session.requestAnimationFrame(onXRFrame);

            const pose = frame.getViewerPose(referenceSpace);
            if (!pose) return;

            const hit = frame.getHitTestResults(hitTestSource);
            if (hit.length > 0) {
                const hitPose = hit[0].getPose(referenceSpace);
                lastHit = hitPose.transform.position;
            }
        }

        // ---------------------------
        // ⑤ 各ボタンイベント
        // ---------------------------
        document.getElementById("resetBtn").onclick = () => {
            taps = [];
            document.getElementById("info").innerText = "画面を2回タップして長さを測定";
        };

        document.getElementById("backBtn").onclick = () => {
            window.location.href = "index.html";
        };

        document.getElementById("saveBtn").onclick = async () => {
            if (taps.length < 2) {
                alert("2点タップが必要です");
                return;
            }

            const length = calcDistance(taps[0], taps[1]);

            const res = await fetch("backend/save", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ length })
            });

            alert("保存しました");
            window.location.href = "index.html";
        };

        // ---------------------------
        // ⑥ 起動
        // ---------------------------
        startAR();
    </script>
</body>
</html>
